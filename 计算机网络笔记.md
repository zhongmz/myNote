# 网络体系

## 功能和组成

### 计算机网络是什么？

- 自治计算机互联起来的集合体

### 计算机网络的功能是什么？

- 数据通信
- 资源共享
- 并行和分布式处理
- 提高可靠性
- 好的可扩充性

### 计算机网络的组成

#### 按功能分类

- 负责**数据处理**的计算机和终端
- 负责**数据通信**的通信控制处理及和通信线路

#### 按逻辑功能分类

- **资源子网**
  - 计算机系统、网络终端、外部设备（ 如打印机等）、各种软件资源与数据资源组成。
- **通信子网**
  - 通信控制处理机，通信线路及其他通信设备组成



### 什么是网络资源？

- 硬件资源，软件资源，数据资源





## 拓扑结构

### 什么是网络的拓扑结构？

- 指网络中的结点间的互连模式【网络链路和结点的集合布局】

### 常见的拓扑结构有哪些？

- 网状
- 星状
- 树状
- 总线型
- 环状
- 混合型

### 网状【广域网】

#### 特点

- 每个结点都有一条连接

![image-20201118092936254](https://i.loli.net/2020/11/18/YoG8FOTJDbmuQ1e.png)

#### 优点

- 避免拥塞
- 健壮性好
- 具有安全性
- 故障排查简单

#### 缺点

- 贵

### 星状【以太网是星状】

#### 特点

- 每个设备只与中心控制器连接

![image-20201118092945676](https://i.loli.net/2020/11/18/QUMwcrnbsTY1qBZ.png)

#### 优点

- 简单
- 健壮性
- 便于管理

#### 缺点

- 中央控制器是瓶颈

### 树状

#### 特点

- 是星状的扩展【绝大多数设备先连到**次级控制器**中，再由次级控制器连到**中央控制器**
- ![image-20201118093157596](https://i.loli.net/2020/11/18/UTDtefZikHPpl1C.png)

#### 优点

- 具有星状的优点
- 更多设备相连
- 允许隔离

#### 缺点



### 总线

#### 特点

- 由一条长电缆组成的**主干**和连接到上面的**网络设备**组成

![image-20201118093842957](https://i.loli.net/2020/11/18/Sx8MUvcNDTI3oAt.png)

#### 优点

- 没有路由和转发的问题
- 容易安装

#### 缺点

- 故障排查困难
- 有信号衰减

### 环状

#### 特点

- 每个设备通过一个首尾相连的链路连接起来构成网络

![image-20201118094023961](https://i.loli.net/2020/11/18/qpR4iwOICKYXTgB.png)

#### 优点

- 容易配置
- 故障隔离简单

#### 缺点

- 网络规模大，延迟大
- 容易网络瘫痪

### 混合型

## 网络分类

- 略

## 网络分层体系结构

### 网络协议和分层

#### 什么是网络协议？

- 通信双方必须遵守的规则

#### 网络协议的3要素

- 语法
- 语义
- 时序

#### 分层的好处

- 各层独立
- 灵活性好
- 结构可分隔
- 容易实现和维护
- 有利于标准化

### 分层的原则

- 略

### ISO OSI参考模型

#### 物理层

- `bit`为单位

#### 数据链路层

- `MAC`地址
- 把相邻2个结点不可靠的物理链路变成可靠无差错的逻辑链路
- 单位`frame`帧

#### 网络层【路由】

- `IP`地址
- `packet`包，分组
- 任务是选择合适的路由和交换结点
- 解决网络互连，拥塞控制等等
- 在TCP/IP的网络层功能是寻址，数据打包，路由选择，除此之外，还有地址解析协议`ARP`，反向地址解析协议`RARP`，`Internet`协议`IP`,Internet控制消息协议`ICMP`，`Internet`组管理协议`IGMP`

#### 传输层【进程-进程】

- 端口号
- `message`报文





:dog











# 物理层

- `bit` 比特
- 一个结点如何把计算机连接到通信介质

TCP/IP 网络体系结构

- TCP/IP未定义物理层协议



## 传输介质

### 有线介质

### 双绞线

####  双绞线为什么要双绞合？

- 减少相邻导线的电磁干扰

#### 为什么要屏蔽层？

- 进一步提升抗电磁干扰能力

#### 双绞线的分类

- 屏蔽双绞线 `STP`

- 非屏蔽双绞线 `UTP`

  - `UTP`是通过`UTP`连接器来连接的，其分为阳性插头和阴性插座

    [![UTP连接器](https://s1.ax1x.com/2020/10/21/BP3lHH.png)](https://imgchr.com/i/BP3lHH)

    ![image-20201120141137961](https://i.loli.net/2020/11/20/vdImaRGxTXsF9gq.png)







### 同轴电缆 【主要用于有线电视】

- 50$\Omega$同轴电缆
- 75$\Omega$同轴电缆

#### 为什么同轴电缆比双绞线的传输速率更快？

- 因为同轴电缆具有更高的屏蔽性和抗噪声性





### 光缆【适合远距离传输】

- 构成

  [![BPGwkj.png](https://s1.ax1x.com/2020/10/21/BPGwkj.png)](https://imgchr.com/i/BPGwkj)

- 原理 当折射率小于1时，将不会再发生折射，所有的光线都会被反射。

- 传播模式

  - 多模传播 用于近距离传播【原理是利用了光的全反射特性】
    - 阶跃模式
    - 渐变模式
  - 单模传播 成本高，用于远距离传播

-  光纤种类

  - 多模阶跃光纤
  - 多模渐变光纤
  - 单模光纤

## 无线介质

- 分类为 定向和全向

### 地面微波

### 卫星微波

### 红外线通信

## EIA-232接口标准【物理层屏蔽物理设备的差异，使得数据链路层只需要考虑本层的协议】

### 机械特性【引脚的规格】

### 电气特性【规定线路上的电压等物理特性】

### 功能特性【出现某种电压是什么意义】

### 规程特性【工作规程和时序关系】



## 物理层互连设备

### 中继器【又称转发器】

- 在物理层实现透明二进制比特的复制，**补偿**信号的衰减，本质上是放大数字信号

#### 什么是5-4-3规则？

- 在一个由中继器互联的网络中，最多有5个网段，4个中继器，3个主机段

### 集线器Hub

- 相当于多端口的中继器，采用广播方式发送数据 又称**多口中继器**

### 无线AP

- 组建小型无线局域网时最常用的设备，连接有线网和无线网的桥梁

# 数据链路层

- 单位`frame` 帧
- 将**相邻**结点不可靠的物理链路变成**可靠**无差错逻辑链路，所以数据链路层的帧**不能跨网关**传输【毕竟这个时候还没有路由器的定义】
- `MAC `地址，网卡

## 主要工作

### 线路规程



### 差错控制

### 流量控制



### 链路管理

#### 什么是链路管理？

- 数据链路层连接的**建立，维持和释放**称位链路管理【用于面向连接的服务】

TCP/IP 网络体系结构

- TCP/IP未定义数据链路层协议
- 数据链路层在`TCP/IP`中是认为不可靠的，网络层也不利用数据链路层可能存在的序号和响应服务；因此保证可靠的通信是`TCP/IP`中的传输层的任务。

## 线路规程

- 有2种方式，询问/确认方式和轮询/选择方式

### 询问确认模式

#### 使用场合

- 2个设备之间有一条专用链路（点对点）
- 若双方等级相同，任意一个设备都可以启动会话

#### 工作方式

- 启动方首先发送一个询问帧（ ENQ ）询问接收方是否可以接收数据。
- 接受方的应答有3种情况
  - 没有应答，此时启动方假定询问帧丢失，断开连接再次发送，进行3次尝试后则放弃
  - 否定应答，启动方进行3此尝试后则放弃
  - 肯定应答，启动方随时发送数据，直到发送完毕，最后以传输结束帧`EOT`结束传输。

![询问确认](https://i.loli.net/2020/10/23/t18U9ecfd2QPKML.png)

### 轮询选择模式

#### 使用场合

- 多点连接，一个设备为主设备，其他设备为从设备
- 不仅仅要确定设备是否就绪，还要确定哪个点有权使用信道

#### 工作方式

- 主设备控制链路，主设备发送命令，从设备响应

#### 地址问题

- 链路上的每一个设备都有一个地址来标识自己
- 在任何一次传输中，每一帧都有对应的地址域，若该帧从主设备来，指明其接收者；若该帧从从设备来，指明其产生者。

#### 选择模式

- 每当主设备有数据发送时采用选择模式
  - 在发送数据前，主设备产生并发送一个选择帧`SEL`，并在地址域中填入从设备的地址，链路上的每一个设备都可以接受到数据帧，但是只有发现地址是自身的时候才打开。
  - 从设备是激活的且运行的，并且和选择帧的地质域相同，它向主设备发送一个确认帧`ACK`
  - 然后主设备发送一个或多个数据帧

![多点选择](https://i.loli.net/2020/10/23/cZHytIJACLMNBKp.png)

#### 轮询模式

- 主设备请求从设备进行传输，在没有接到请求前，从设备不允许**发送**数据
- 若从设备没有数据传输，则发送否认应答帧`NAK`
- 若有数据，则发送数据帧
- 2种终止信息交互方式
  - 从设备把所有数据发送完毕，并且以`EOT`结束传输
  - 主设备发送“时间到”信息

![多点轮询](https://i.loli.net/2020/10/23/geS9QDHmtYLbxTU.png)





## 流量控制与差错控制

### 什么是流量控制？

- 流量控制是一组过程，这组过程告诉发送方在等待接收方的**应答信号之前**最多可以传送多少数据
- 流量控制的2个要点

1. 数据流不能使接收方过载
2. 应答

### 什么是差错控制？

- 用以使发送方确认接收方是否正确收到数据的方法称为**差错控制**

### 如何确保接收方不会接收重复帧？

- 帧编号机制



- 错误检测

- 重传方法

- 自动重复请求`ARQ Auto Repeat reQuest`：在一个帧出现错误，接收方就返回一个否认帧，出错的帧被发送方重新传送

  

  

### 数据被重传的3种情况

1. 帧破坏
2. 帧丢失
3. 确认帧丢失

### 实现流量控制和差错控制的方法

- 停止等待协议
- 滑动窗口协议

### 停止等待协议

#### 流量控制

- 发送方每发送1帧后就等待一个确认帧，只有当接收到确认帧后，发送方才发送下一帧，因此不会出现过载的情况
- 优点：简单
- 缺点：效率低，因为线路上总是只有一帧，若设备的距离很长，则等待确认所花费时间长

#### 完成一帧发送的最短时间

$$
WT = t_I+2t_P+2t_{Proc}+t_S\\
t_I=L_f/C\\
t_S=L_S/C\\
其中L_f是数据帧长度，C是发送传输速率
\\
其中，WT是窗口时间
\\t_I是发送一个数据帧的时间
\\
t_P是电信号在物理链路上的传播延迟
\\
t_{Proc}是接受到一帧的处理时间和一帧的形成时间\\
t_S是确认帧的发送时间
$$

![最短时间](https://i.loli.net/2020/10/23/SevBAQD3U9PaXf7.png)

#### 定量分析

##### 无差错时信道利用率和有效数据传送速率

- 信道利用率

$$
t_I/WT
$$

- 有效数据传送速率【单位时间内传送的有效位数】

$$
N/WT,其中N为数据帧的比特数
$$

##### 有差错时**正确**传送一帧的平均时间和系统的最大吞吐量

- 假设数据帧出错的概率为p

- 平均时间
  $$
  t_V=(1-p)WT+p(1-p)2WT+p^2(1-p)3WT+...=\frac{WT}{1-p}
  $$

- 系统最大吞吐量【每秒成功发送的帧数】
  $$
  \lambda_{max}=\frac{1}{t_V}=\frac{1-p}{WT}
  $$

- 系统极限吞吐量【不考虑流量控制和差错控制】
  $$
  \lambda=\frac{1}{t_I}
  $$

- 传输效率【最大吞吐量和极限吞吐量的比值】
  $$
  不妨设a=\frac{WT}{t_I}
  \\
  \frac{\lambda_{max}}{\lambda}=\frac{1-p}{a}\\
  $$

#### 差错控制

**要求**

- 发送设备收到应答前必须保留数据帧备份
- 识别各帧选哟数据帧和确认帧交替使用01
- 若在数据帧中发现错误，接受设备发送NAK否认帧，此时是不编号的
- 发送设备安装定时器，在规定时间内未收到确认信息则重传

##### 有以下3种错误帧错误

###### 帧破坏的处理方法是什么？

- 接收方发送否认帧

###### [帧丢失]的处理方法是什么？

- 发送方计时器超时重传

###### 确认帧丢失的处理方法是什么？

- 发送方计时器超时重传

![自动重复请求3种错误](https://i.loli.net/2020/10/23/qFUV68hGJzZdECv.png)



### 滑动窗口协议

#### 流量控制

- 发送方窗口用于存放已经发送但未确认的数据帧和在收到确认帧之前可以发送的数据帧
- 接收方窗口用于存放已经被接收但未发送确认帧的数据帧和可以被接收的数据帧



![发送方窗口](https://i.loli.net/2020/10/23/CrEL6iMetw7KjfO.png)



![接收方窗口](https://i.loli.net/2020/10/23/nUaoMY1Qx3Ou9fZ.png)

#### 差错控制

- 2种实现自动重复请求的技术
  - 回退n自动重复请求
  - 选择拒绝自动重复请求
- 为解决帧丢失和帧损坏的重发问题，增加以下特性
  - 数据帧被确认前保持它们的所有备份
  - 接收方可以发送否认帧【为了告诉发送方重新发送一个损坏的帧】 注意：确认帧带有期望收到的数据帧的编号，否认帧带有被损坏帧的编号
  - 发送设备具有定时器



##### 回退n自动重复请求

- 若一帧丢失或损坏，未被确认的所有帧都必须重传

###### 数据帧被破坏

![数据帧被破坏](https://i.loli.net/2020/10/23/Za9WPB2rLjHUKiG.png)



###### 数据帧丢失

![数据帧丢失](https://i.loli.net/2020/10/23/4eTJRgwlrbd6y51.png)

###### 确认帧丢失

![屏幕截图 2020-10-23 191951.png](https://i.loli.net/2020/10/23/pYWoAMmvJKyiujZ.png)

###### 窗口大小和编号范围的关系

假设帧的编号范围是0~n-1，则窗口的尺寸为**n-1**

- 若窗口大于n：接收确认帧的时候不知道是哪一个帧的确认帧

- 若窗口等于n：有如下情况发生

  ![窗口尺寸为n](https://i.loli.net/2020/10/23/6QtDNMe2jzVgprP.png)

##### 选择拒绝自动重复请求

- 只有特定的丢失或损坏的数据帧被重发
- 与回退n自动重复请求的不同
  - 接收设备具有排序的功能
  - 发送设备具有查找的功能
  - 确认帧的编号是指被正确接收的帧
  - 在重传帧被排序和重复帧被删除前，所有帧都要被保存
- 破坏帧

![破坏帧](https://i.loli.net/2020/10/23/6vAWzcMdRjqNeTB.png)

- 丢失帧

![丢失帧](https://i.loli.net/2020/10/23/yDG3BeMKF2YwRVX.png)

- 确认帧丢失 与回退n相同

###### 窗口大小和编号范围

- 若帧的编号范围是0~n-1，则发送窗口和接收窗口的尺寸之和**小于或等于n**



### 滑动窗口协议的效率

#### 正确传送一帧的平均时间

$$
t_V=t_I+\frac{pt_W}{(1-p)},p为差错率
$$

#### 系统最大吞吐量

$$
\lambda_{max}=\frac{1}{t_V}
$$

#### 系统传输效率$\rho$

$$
\rho = \frac{(1-p)}{1+p(a-1)}
$$



#### 窗口大小的选择

- 假设一个帧的发送时间是$t_I$，传播时间是$t_P$，则窗口的大小n满足
  $$
  nt_I>2(t_I+t_P)
  $$

#### 信道利用率和最佳帧长

- 信道利用率不可能达到100%
- 当帧长取得过小，那么控制信息的比重小，若帧长过大，那么重传的代价高



## 面向比特型通信协议HDLC协议

### 站点类型

- 主站点
- 从站点
- 复合站点



### 链路配置

- 非平衡式（多点）
- 对称式（点对点）
- 平衡式：能同时命令和应答

![链路配置](https://i.loli.net/2020/10/23/HbehEr6iWs5cJLl.png)

### 通信方式

- 描述在一次交互中所涉及的2个设备的关系（由谁控制链路）

- 有3种不同的通信方式
  - 正常应答方式`NRM`，即非平衡式
  - 异步应答方式`ARM`，即非平衡式
  - 异步平衡方式`ABM`，即平衡方式



### HDLC帧格式

#### 信息帧 `I-帧`      传输用户数据

#### 监控帧`S-帧`       传输控制信息

##### 接收就绪帧

###### 应答ACK

###### 查询POLL

###### 对查询的否定应答

###### 对选择的肯定应答



##### 接收未就绪帧

###### 应答

###### 选择

###### 对选择的否定应答

##### 拒绝帧

##### 选择拒绝帧





#### 无编号帧`U-帧`   进行链路管理服务

- 5 个基本功能类
  - 方式设置
  - 无序号交互
  - 断开连接
  - 启动模式
  - 混杂形式

具体见p86

- 捎带确认： 把发送信息和与应答相关的控制信息结合到一帧中的技术



## IEEE 局域网通信协议

- 目前在局域网协议中所用到的**数据链路控制部分**都是基于**HDLC 协议**的
- IEEE 将数据链路层划分为两个子层：
  - 逻辑链路控制(LLC) 子层
  - 媒体访问控制(MAC) 子层
- IEEE 802.1 解决局域网和城域网( MAN ) 中的网络互连问题
- IEEE 802.2: 它是LLC 协议标准。

### IEEE局域网参考模型

![IEEE标准和OSI对比](https://i.loli.net/2020/10/24/QaEqS9DTYzO8BIW.png)

#### 第一层 物理层

物理层以透明方式向上一次提供了一个物理连接，其中有2个子层

- 介质访问单元MAU，作用是信息编码，信号发送，介质处理
- 介质说明（即电缆说明）

#### 第二层 数据链路层

- 逻辑链路控制LLC子层，对于所有的LAN协议【局域网协议】都是相同的
- 媒体访问控制MAC子层，解决共享介质竞争使用的问题，包含了数据传输的同步，标记，流量控制，差错控制，以及下一站的物理地址

![屏幕截图 2020-10-24 194319](https://i.loli.net/2020/10/24/6pfI8HOj1LqFx2S.png)

### LLC

![屏幕截图 2020-10-24 194440](https://i.loli.net/2020/10/24/LyrKY9Oc7sxHapG.png)

- 其中LLC的控制字段有3种
  - 信息帧
  - 监控帧
  - 无编号帧

#### LLC地址与MAC地址的对比

- MAC帧的地址是物理地址，LLC帧的DSAP和SSAP是逻辑地址
- 其中DSAP首位是0表示个体，1表示组
- 其中SSAP首位是0表示命令，1表示响应

#### LLC子层向上一层所提供的3种服务

##### 非确认的无连接服务 质量由高层保证

##### 面向连接服务 3个阶段：连接建立；数据传输；释放连接

##### 确认的无连接服务：对数据帧进行确认



## 以太网

- 以太网标准由IEEE802.3所支持的局域网标准所扩展
- IEEE802.3定义了基带标准【数字】和宽带标准【模拟】
- 基带标准 其中 10标明以Mbps为单位的数据传输速率，最后的数字or字母指明了最大电缆长度和电缆的类别，base标志基带传输；使用曼彻斯特编码
  - 10Base5
  - 10Base2
  - 10Base-T
  - 1Base5
  - 100Base-T
- 宽带标准 与基带标准的含义相同
  - IEEE只定义了10Broad36

### 以太网访问模式CSMA/CD

- 使用的是CSMA/CD媒体访问控制 称之为 带有冲突检测的载波侦听多路访问
  - MA：多路访问：不听就说
  - CS：载波侦听：先听后说
  - CD：带有冲突检测，边说边听

#### 多路访问MA



### 载波侦听多路访问CSMA

- 若帧听到链路是非空闲的，则避让一段时间，根据不同的算法来避让

##### 非坚持CSMA

- 若忙，则等待一段随机时间，再发送
- 优点：减少冲突的可能性
- 缺点：链路的利用率低

##### 坚持CSMA

- 若忙，则一直侦听直到空闲，则立即发送
- 若有冲突，则等待随机时间，再侦听

##### P-坚持CSMA

- 若空闲，则以P的概率发送，以1-P的概率延迟一个时间单位，这个时间单位为传播延迟的2倍

- 如何选择P值：若选择P过大，使得NP>1，那么当多个站试图发送，冲突无法避免，所以必须选择P值使得NP<1，若P值选择过小，则链路利用率会大大降低。

### CSMA/CD

- 在传输的时候继续侦听链路，一旦检测冲突，就立即停止发送，向链路上发送一串阻塞信号。
- 对比CSMA
  - CSMA浪费掉的是整个帧的传输时间
  - CSMA/CD浪费掉的是检测冲突时间
- 冲突检测窗口=最大传播延迟的2倍
- 同时也说明了以太网的**MAC帧最小长度**为2倍的传播延迟

![屏幕截图 2020-10-24 210906](https://i.loli.net/2020/10/24/u7oYPUQwbKiRhqB.png)

#### 退避算法

- 若检测到冲突，发送阻塞信号，然后等待一个随机的时间

1. 对每一个帧， 当第一次发生冲突时，设置参数L=2 。
2. 退避间隔取l 到L 个时间片中的一个随机数，其中一个时间片等于最大传输延迟【冲突窗口】【路由器将分组推出所需要的时间，和路由器的距离无关】的**2倍**
3. 当帧重复发生一次冲突时，则将参数L 加倍。L 的最大值为1 024, 即当L 增加到1 024时， L 不再增加。
4. 帧的最大重传次数为16, 超过这个次数，则该帧不再重传，并报告出错。

- 从这个退避算法中可以看出，未发生冲突的帧或发生冲突次数较少的帧，具有优先发送的概率；而发生过多次冲突的帧，成功发送的概率反而要小。
- 等待时间

$$
t=R*2T
$$



### 最短帧长

$$
L_{min}=2T*R\\
T=\frac{D}{V}\\
其中L_{min} 是最短帧长【bit】
\\ R是数据传输速率【bps】
\\ D是最大距离【m】
\\V是传播速度【m/s】
$$



- 冲突：叠加后的信号将无法识别
- NIC：网络接口卡，每一个站点都有唯一的NIC
- 冲突检测窗口：检测冲突所需要的时间
- 10Mbps以太网的规定参数：
  - 冲突窗口为51.2us
  - 因此10Mbps的最小帧长是64字节【51.2us*10Mbps]
- 例：在10Mbps 以太网中，当发送站第二次发生冲突时，可能的退避时间={51.2us 102.4 us 153.6 us 204.8 us}







### 以太网MAC帧格式

#### 前导码

#### 1.SFD （ 帧起始分界符）

#### 2.DA （ 目的地址）

#### 3.源地址( SA)

#### 4.LLC-PDU 的长度／类型

#### 5.LLC-PDU

#### 6.CRC





## 无线局域网

## 补充：成帧的方法

### 字符记数法

- 帧的长度用一个字节表示，作为帧的首部的一个域
- 一旦帧长度有误，则无法再同步

### 含字节填充的分界符法

- 用特殊的字符作为帧头和帧尾`FLAG`

### 含位填充的分界标致法

- 以特殊的位模式为帧标志`01111110`
- 当遇到连续的5个1，在第5个1后面插入0

### 物理层编码违例法

- 在曼彻斯特编码中没有`1-1`和`0-0`这样的编码，所以可以使用来作为帧的定界符



## 其他

### 链路层的协议标准有哪些？

- HDLC
- PPP
- SLIP





# 网络层

## 前言

- `packet` 分组\包
- 选择合适的路由和交换结点
- `IP` 主机

###### TCP/IP 网络体系结构

- 主要功能：寻址，数据打包，路由选择
- `IP`协议，无连接的协议

### 网络层的作用是什么？

- 为了实现端到端的传递

### 网络层属于通信子网中的哪一层？

- 最高层
- 并且是主机和通信子网的接口

### 主要的协议

#### 地址解析协议ARP

- IP->MAC

#### 反向地址解析协议RARP

- MAC->IP

#### Internet控制消息协议ICMP

#### Internet组管理协议IGMP



## 网络层的服务和功能

### 网络层的功能

#### 为了实现端到端，网络层提供了哪些功能？

##### 信宿和信源的传输

##### 逻辑寻址 

- 在头部加入源地址和目的地址

##### 路由：选择最佳路径

- 选择信源到信宿发送数据包的**最佳**路经

##### 地址转换

- MAC->IP 或者IP->MAC

##### 复用

- 同一条**物理线路**同时**传输多个**设备间的数据。

##### 流量和拥塞控制

- 在部分报文丢失时通知发送方,调节发送的流量

##### 网络互连

- 发送端和接收端结点可能不在一个网络内，要成功实现端对端的传送，必须解决网络互连的有关问题。

##### 交换：建立临时连接

- 本质上是多段物理链路连接成一条通信路径。



#### 在OSI模型中，网络层提供了哪2种服务？

##### 面向连接的网络服务 CONS

##### 面向无连接的网络服务CLNS

- 在TCP/IP中，网络层只提供无连接的服务



### 面向连接的网路服务

- #### 建立了一条虚电路

#### 传输过程

· 发送者发送一个连接请求包。
· 接收者使用一个连接确认包进行确认。
· 发送者传输数据。
· 发送者发送一个连接终止请求包。
· 接收者使用一个连接终止确认包进行确认。



### 面向无连接的网络服务



## 网络互连设备

### 网络互连设备有哪些？

#### 集线器

#### 交换机

#### 路由器【主要】

![image-20201106140935751](https://i.loli.net/2020/11/06/Tk9SnVqpNIu4fOr.png)

### 路由器

#### 路由器和交换机的区别是什么？

- 交换机工作在**数据链路层和网络层**，根据MAC地址寻址；而路由器工作在三层，根据IP地址寻址
- 交换机主要负责交换数据；路由器主要负责路由

![image-20201106141919657](https://i.loli.net/2020/11/06/1OqFyGCHSbL5dYe.png)

### 第三层交换机

- 三层交换机具有**交换**和**路由**的功能
- 除此之外还有转发基于第三层地址的业务流；还有报文过滤功能

### 网关

#### 什么是网关？

- 网关是一个**协议转换器**，**通常**安装在路由器内部的软件
- **更重要的是**，网关还是一个**网间连接器**，若主机发送的数据包的目的IP不是**本地网络**，则发给**网关**，由网关来发送给另外一个网络
- 可以工作在**7层**

#### 路由器和网关

- 路由器实现了**网关的功能**

## 路由选择原理

### 什么是路由选择？

- 网络中的每一个节点为到来的数据包**选择一条输出链路**

### 什么时候进行路由选择？

- 若使用**数据报**，那么为每一个到来的包作一次路由选择
- 若使用**虚电路**，那么在建立虚电路的时候进行一次路由选择

### 路由选择的基本要求有哪些？

#### 正确性

#### 简单性【计算简单】

#### 坚定性

#### 稳定性【收敛算法】

#### 公平性

#### 最佳性

### 分布式路由选择策略

- 比如RIP，OSPF

### 集中式路由选择算法

### 基本路由算法【重点】

#### 什么路径是最佳路径？

- 距离最短的路径

#### 距离可以使用什么来量度？

- 费用
- 传输延迟
- 数据传输速率

#### 2种常用的计算最短路径的方法

##### 距离向量路由

##### 链路状态路由

### 距离向量路由算法【重点】

- 每个路由器**周期性【30s】**的将自己关于**整个网络的信息**发送给它的**邻居**

#### 路由表中的一项

```
NetID : Distance : Nexthop
```

![image-20201106144256739](https://i.loli.net/2020/11/06/DueKmboFYp8LkxX.png)

- RIP使用了这个算法

#### 特点

- 简单开销小；适合小规模
- 对于网络规模伸展性差；对链路状态变化响应慢



### 链路状态路由算法【重点】

- 每个路由器**周期性【30min】**和互连网络中的**所有其它路由器**共享关于它**邻居**的信息

- OSPF协议使用了这个算法

#### 计算路由表步骤

##### 共享链路状态信息

###### 如何共享链路状态信息？

- 路由器通过向所有路由器发送链路状态包【LSP】

###### 一个LSP中有什么？

- 广告者的ID
- 所影响的目标网络ID
- 费用
- 邻居路由器的ID

###### 一个新的路由器在启动的时候如何获取链路状态信息？

- 向所有**邻居**发送**问候包**得到每条链路的状态信息
- 基于问候的结果准备发送一个LSP扩散到网络中

##### 计算路由表【Dijkstra算法】

- 从路由器到网络的链路的费用有效，而从网络到路由器的链路的费用总是为0

###### 如何形成自己的最短路径树？

- 见PPT46



#### 特点

- 与距离向量算法相比，链路状态算法具有更快的收敛速度。
- 链路状态算法具有更好的功能扩展能力
- 路由状态算法还提供了更好的在规模上的可升级性



![image-20201106150401090](https://i.loli.net/2020/11/06/kudSGrBTRwi2QHp.png)

- 其中路由选择是在软件层面，分组转发是在硬件层面

## 拥塞控制和流量控制

### 拥塞控制

#### 拥塞控制的目的？

- 防止整个网络或网络的一部分出现过多的数据包

#### 什么是拥塞？

- 网络或其一部分出现**过多的包**，导致网络性能下降的现象

#### 为什么会造成拥塞？

- 结点的处理速度
- 链路的传输速度不够高。

#### 拥塞造成的影响有什么？

- 系统吞吐量和传输延迟的影响

![image-20201106151635295](https://i.loli.net/2020/11/06/t2Behifxk7JIKPg.png)

- 在轻负载的情况下，有拥塞控制时，包的延迟反而会比无拥塞控制时的大，这是因为有拥塞控制时需要额外的开销。

#### 控制拥塞的方法

##### 预分配缓冲区【常用于虚电路技术】

##### 丢弃包【仅适用于拥塞是突发性通信所造成的】

##### 限制网内包数量【比如设置许可证】

##### 流量控制【重点：用于接收端调节发送端发送数据的速率】

##### 阻塞包【当达到警戒状态就像源主机发送一个阻塞包】

### 流量控制

#### 流量控制的目的？

- 保证发送方发送的**信息量**不会超过**接收方**的接收能力

![image-20201106152808273](https://i.loli.net/2020/11/06/yNGugVBjKMRmziT.png)

#### 流量控制有哪些层次？【见上图】

##### 主机－主机【传输层协议】

##### 源结点-目的结点【网络层协议】

- 和通信子网工作方式有关

###### 若使用虚电路的工作方式

- 虚电路方式本身要求有基本的缓冲区，包沿固定路径传送，因此不需要额外的流量控制

###### 若使用数据报方式，且其缓冲区是先到先服务且全部分配

- 可能产生死锁

![image-20201106154457698](https://i.loli.net/2020/11/06/4SkFAyKYXqrUpBs.png)

![image-20201106154513661](https://i.loli.net/2020/11/06/HIclU4R7BGPT3EO.png)

- **解决办法：输入链路预留缓存，并允许丢包**

  



###### 若通信子网使用数据报，在向传输层提供虚电路服务

- 可能产生**重装死锁**

![image-20201106154634901](https://i.loli.net/2020/11/06/hIUuob8tSCLdHcZ.png)

- **解决办法：分配重装缓冲、并预约缓冲**





##### 主机-源结点【数据链路层，网络层】

- 本质上是控制进入通信子网的信息量

###### 主要采用的方法

- 停止等待流量控制
- 缓冲区预约
- 许可证方案

##### 相邻结点【数据链路层】



## IP协议

### IP协议为高层提供什么数据报通信？

- 不可靠、无连接

### IP地址的分类

![image-20201106155433480](https://i.loli.net/2020/11/06/72zBshZJYI5lNoy.png)

![image-20201106155945729](https://i.loli.net/2020/11/06/q6UOuQhTY23ogjv.png)

- 当主机号全0的时候作为网络号的表示，当主机号全1的时候作为主机的广播地址，所以减去2

### 特殊的IP地址

#### 网络地址：主机号全为0的地址

#### 0.0.0.0：不认识的IP集合

- 比如还没有分配IP地址的主机发送IP报文时的**源地址**

#### 直接广播地址：主机号全为1

- 可通过路由器跨网广播

#### 有限广播地址：32位全为1的IP地址

- 仅用于本网传播

#### 环回地址：第一个字节为127的IP地址【eg 127.0.0.1】

- 用于测试本机上的网络程序

#### 私有地址

- 用于企业内部

- 10.0.0.0 — 10.255.255.255
- 172.16.0.0 — 172.31.255.255
-  192.168.0.0 — 192.168.255.255

![image-20201106160904450](https://i.loli.net/2020/11/06/A1g43Kok9mlMVUn.png)



### IPv4报文格式

![image-20201106161035309](https://i.loli.net/2020/11/06/jYawoXE7kGlOv6I.png)

#### 报头长度

- 报头占有多少**32位**，即多少个**4B**，

  ```
  20B<= 报头 <= 60B
  5<=报头长度<=12
  ```

#### 服务类型

- 略 见PPT102，第2版213
- 其中两者分别描述了老版本和新版本

#### 总长度

- 指整个IP 数据报的长度，以**字节**为单位
- 利用报头长度和总长度可以得到数据部分的起始位置
- IP数据报最大可达最大长度可达65 536 字节【根据该字段是16B】

#### 标识字段

- 在分段中使用
- 同一数据报的每个分段将在这个域中使用一个相同的序列号来识别。通常每发送一个报文，其值自动加l

#### 标志字段

- 第一位没有使用
- 第二位为DF 位，该位被置l 表示不要分段
- 第3 位是MF 位，该位被置l 表示该分段后还有进一步的分段

#### 分段偏移

- 说明该分段在当前数据报的位置
- 以8 字节为单位，这样偏移量1 对应字节号8

#### 生存时间

- **最多路由器数量**
- 防止兜圈子
- 一旦经过一个处理该数据报的路由器，它的值就减去l 。当该字段的值为0 时，该数据报被丢弃，并发送ICMP 报文通知源主机。

#### 协议字段

- 确定是**哪一个协议向IP**发送数据报

#### 报头校验和字段

- 根据IP 报头计算的校验和，**不对数据**计算

#### 源IP 地址和目的IP 地址

#### 任选项



### 子网编址与子网掩码

#### 如何解决IP地址原编址方案的不足？

- 增加子网号字段，使得2级地址变成3级地址，这样的方法称为**划分子网**，把主机号进一步划分为一个**子网号**和一个**主机号**。

![image-20201107100317344](https://i.loli.net/2020/11/07/CBXOUcFz6J1MYQi.png)

#### 那么如何区分子网号和主机号呢？

- 使用**子网掩码**
  - 1标识网络号和子网号
  - 0标识主机号

#### 知道IP地址和子网掩码计算出哪些地址？

- 网络地址
- 广播地址
- 地址范围
- 本网有多少主机

#### CIDR 继续解决IP地址不足的问题

- CIDR分为**网络前缀**和**主机**

##### CIDR无分类编制的记法

1. ![image-20201107101729120](https://i.loli.net/2020/11/07/AiWVxBT3oXLtR5F.png)
2. 斜线记法，P 地址后面加上一个斜线“/”，写上网络前缀所占的位数
3. 10.0.0.0/10 可简写为10/10，也就是把点分十进制中低位连续的0 省略
4. 网络前缀的后面加一个星号* 的表示方法，在星号* 之前是网络前缀



#### 如何构成超网？

- 前缀长度不超过23 位的CIDR 地址块都包含了多个C 类地址。这些C 类地址合起来就构成了**超网**

### IP路由选择

- IP路由选择是**基于下一跳的路由**

#### 2种交付方式

##### 直接交付

##### 间接交付【转发】

#### 路由表中每一行有哪些信息？

##### 目的IP地址

##### 子网掩码【在有划分子网情况下】

##### 下一条路由器的IP地址

##### 一个网络接口

#### 转发的特例

##### 特定的主机路由【用于测试】

##### 默认路由

#### 路由器转发算法过程

1. 从数据报的首部提取目的主机的**IP地址D**，得出目的**网络地址N**。
2. 若网络N 与此路由器直接相连，则把数据报直接交付目的主机D；否则是间接交付，转到3
3. 若**D是特定主机**，则把数据报传送给指明的下一跳路由，否则转至4
4. 若路由表中有**到达网络N**的路由，则把数据包传送给指明的下一跳路由器，否则转至5
5. 若路由表中有默认路由，则把数据包送给默认路由器，否则转至6
6. 报告出错

#### 最长前缀匹配CIDR

- 选择网络前缀最长的IP地址



#### 二叉线索查找路由表

![image-20201107105712045](https://i.loli.net/2020/11/07/qeY1tgwhcyoXpu3.png)



### IPv6

#### IPv6的报文格式

![image-20201107111359646](https://i.loli.net/2020/11/07/ADFkwmGWRCHueTM.png)

##### 版本：4bits，指明协议版本

##### 通信类型：8bits，使用一个称为区分服务的业务类型指定数据报所需的一般特征。

##### 流标号：20bits，设计之初的目的是将数据报与一个特定的底层网络路径联系起来。

##### 有效载荷长度：16bits，数据报所携带数据的长度，不包括基本头部。

##### 下一个首部：8bits，用于指定当前头部后面的信息的类型。

#####  跳数限制：数据包在到达目的地之前，如果跳数限制计数器被减小到0，该数据报将被丢弃。

#### IPv6地址0压缩

- ::只能出现一次

- 1080:0:0:800:0:0:200C:417A ➔1080::800:0:0:200C:417A
- 0:0:0:0:0:0:0:0 ➔ ::

### 协议配置

- 具体的配置信息有哪些取决于协议栈

#### 对于使用TCP/IP的主机需要配置的信息有

- IP地址
- 子网掩码
- 默认路由器的IP地址
- 域名服务器的IP地址

#### 对于RARP

- 在LAN上有MAC-IP的对应关系，把物理地址解析成IP地址
- 无法跨越**不同网络**请求地址

#### 对于BOOTP

- 使用IP协议和服务器通信

#### 对于DHCP

- Dynamic Host Configuration Protocol，动态主机配置协议

##### DHCP是如何工作的？

- DHCP使用客户/服务器模型，指定DHCP服务器负责分配IP地址，并把配置参数传送给DHCP客户

##### DHCP使用什么协议？

- DHCP使用**UDP**协议，服务器使用67端口，客户端使用68端口

##### DHCP支持哪3种IP地址分配机制

###### 自动分配【永久的IP】

###### 动态分配【租赁】

###### 人工分配【管理员分配】



##### DHCP的工作过程有哪些？【具体见PPT第5章172】

###### 请求IP地址过程

- 发现阶段
- 提供阶段
- 选择阶段
- 确认阶段

###### 续租IP地址

###### 释放IP地址

## ARP：地址解析协议

### ARP协议的作用是什么？

- 把主机IP地址映射为MAC地址

### ARP协议的工作过程是什么？

- 源主机以**广播方式**发送**ARP协议请求包**
- 网段中的所有主机收到这个包，若**该主机IP和请求包中的目的IP相同**，那么主机对该请求包做出**ARP应答**，把MAC地址发送给源主机

<img src="https://i.loli.net/2020/11/07/bTqiNraypI4kuzd.png" alt="image-20201107115645819" style="zoom: 50%;" />

#### 为什么ARP能够高速运行？

- 因为有ARP高速缓冲，存放了IP地址到MAC地址的映射



#### 什么时候使用ARP【使用ARP的典型情况】

- 主机->本网络的另外一个主机：**找目的主机的MAC**
- 主机->另外一个网络的主机：**找本网络的一个路由器的MAC**
- 路由器->本网络的主机：**找目的主机MAC**
- 路由器->另外一个无哦主机：**找本网络的一个路由器MAC**

## ICMP ：Internet控制报文协议【Internet Control Message Protocol】



### ICMP的工作过程

<img src="https://img-blog.csdn.net/20180530175416942?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JhaWR1XzM3OTY0MDcx/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" style="zoom:50%;" />

- 当:seven:中的ICMP报文在路由器1由于网络问题无法传送给主机A的时候，路由器1不再发送ICMP报文，也就是说当一个ICMP报文的不再产生另外一个ICMP报文

### 哪些情况下不再产生ICMP报文？

- ICMP 差错报文。
- 目的地址是广播地址或多播地址的IP 数据报。
- 作为数据链路层广播的数据报。
- 不是IP 分片的第一片。
- 源地址不是单个主机的数据报，即源地址不能为零地址、环回地址、广播地址或多播地址。





### 为什么要使用ICMP？

- 处理IP协议中**出现错误，目的主机不响应，包拥塞包丢失**的**网络本身问题**，**注意：这里并不是对于数据的差错控制问题**

- 理解为对于**网络质量检测**协议

  

### ICMP报文格式

- ICMP报文封装在IP**数据报**中

<img src="https://i.loli.net/2020/11/07/J2dmpZbKDYl6Weh.png" alt="image-20201107120807365" style="zoom:50%;" />

<img src="https://i.loli.net/2020/11/07/RoHrBDFktKnEveg.png" alt="image-20201107121337305" style="zoom:50%;" />

#### 类型

<img src="https://i.loli.net/2020/11/07/2fDodwavBUerlTH.png" alt="image-20201107121819650" style="zoom:50%;" />

#### 代码：进一步描述某种类型的功能

#### 校验和：覆盖整个ICMP报文**【包括头部和数据】**，注意IPv4只有头部

### ICMP报文类型

#### 查询报文

#### 差错报文

##### 那么问题来了：错误的差错报文会产生差错报文吗？

- 不会
- 为了防止过去允许ICMP 差错报文对广播分组响应所带来的广播风暴。

### tracert程序

- 用于追踪主机到目的主机之间所经**路由**

#### 原理

- 收到到目的主机的IP后，首先给目的主机发送一个TTL=1的UDP数据包
- 经过的第一个路由器收到这个数据包以后，就自动把TTL减1，而TTL变为0以后，路由器就把这个包给抛弃了
- 同时产生 一个主机不可达的ICMP数据报给源主机
- 源主机收到这个数据报以后再发一个TTL=2的UDP数据报给目的主机
- 循环往复最终到达目的主机

## IGMP

- 略

## Internet路由问题

### 有哪些路由协议

#### 内部网关协议IGP Interior Gateway Protocol 

#### 外部网关协议 EGP Exterior Gateway Protocol

### 什么是自治系统AS？

- 处于一个管理机构控制下的路由器和网络群组
- 其中一个AS中的所有路由器需要**相互连接，运行相同的路由协议**

<img src="https://i.loli.net/2020/11/07/yKYzq1Gikj3sDQd.png" alt="image-20201107125220970" style="zoom:50%;" />

### 内部网关路由选择协议

- 举例**OSPF**

#### OSPF工作原理

- 向所有路由器发送信息
- 发送信息是相邻路由器的链路状态
- 周期性发送或者 当链路发生改变时发送



### 外部网关路由选择协议

- 举例**边界网关协议BGP**
- 一种举例向量协议
- 力求寻找一条能够到达目的网络且比较好的路由，而不是最佳

#### BGP发言人

- 每一个自治系统的管理员要选择至少一个路由器作为该自治系统的“ BGP 发言人''
- BGP 发言人往往就是BGP 边界路由器,但是也可以不是

#### BGP报文格式

<img src="https://i.loli.net/2020/11/07/ONdTPEk17Y4mBju.png" alt="image-20201107130031043" style="zoom:50%;" />

#### BGP的报文类型

##### 打开报文

##### 更新报文

##### 保活报文【证实邻居的关系】

##### 通知报文【发送差错】



## 注意！

- 从路由器到网络，有费用
- 从网络到路由器，无费用

### 流量控制和拥塞控制的概念区分

- 拥塞控制是处理到达结点的包数目多于缓冲区的问题
- 流量控制是一种端到端的一种机制，是可以用来消除拥塞的一种方法
- 更重要的区分在于：拥塞控制涉及中间节点，但是流量控制不涉及中间节点



# 传输层

## 前言

- 单位：`massage` 报文
- 把数据**可靠**地从一个进程送到另外一个进程
- `port` 端口

### TCP/IP 网络体系结构

- `TCP `传输控制协议 可靠面向连接的协议，流量控制
- `UDP`用户数据报协议 不可靠面向无连接

<img src="https://i.loli.net/2020/11/08/5gOUWJjZaQGRtcs.png" alt="image-20201108095626574" style="zoom:50%;" />

### 传输层有哪些服务？

#### 端到端的报文传递

#### 服务点的寻址

#### 拆分和组装

#### 连接控制

### 端到端通信的时候需要知道哪些地址？

#### TSAP 地址 传输访问服务点，称为端口号

#### NSAP 地址 网络服务访问点

### 传输层可靠性体现在哪些方面？

- 差错控制：一般使用检查和算法，软件实现
- 次序控制：分段和连接 、**序列编号**
- 丢失控制：丢失重传
- 重复控制：通过**序列编号**完成

#### 差错控制

<img src="https://i.loli.net/2020/11/08/P2leLN9MWXpIghO.png" alt="image-20201108100426785" style="zoom:50%;" />

#### 次序控制

##### 分段和连接

- 当数据段太大时候，使用分段来使得数据段变小，接收方需要**重组**
- 当数据段太小时候，使用连接来使得数据段变大，接收方需要**分割**

##### 序列编号

- 大多数传输层服务在每个段的结尾增加一个序列编号
- 其中，每个段中还有一个域来指明该段是否最后一段

#### 丢失控制

- 也是通过序列编号

#### 重复控制

- 也是通过序列编号

### 流量控制【滑动窗口协议】

#### eg

![image-20201108102601442](https://i.loli.net/2020/11/08/CvxqZTDIup2sX9K.png)

![image-20201108102636101](https://i.loli.net/2020/11/08/9nx7SMkszdePNZR.png)

#### 应答控制包丢失会导致什么后果？

- 死锁，因为应答包没有序列号，无法检查是否丢失，又不能超时重传

#### 如何解决死锁？

- 接收方发送应答包
- 发送方发送分配缓冲包



### 传输层拥塞控制

#### TCP拥塞控制的4种算法

- 慢启动【指数增加】
- 拥塞避免【线性增加】
- 快速重传
- 快速恢复

#### 一些术语和定义

##### SMSS【发送端最大数据段尺寸】

##### rwnd【接收端窗口】

- **接收方**可接收的**最大数据量**

##### cwnd【拥塞窗口】

- **发送方**在收到确认帧之前能向网络传送的**最大数据量**

##### ssthresh【慢启动阈值】

- 在任何时候,TCP发送的序号<=min(最大确认序号，cwnd,rwnd)

#### 慢启动和拥塞避免

<img src="https://i.loli.net/2020/11/12/kfb2VTsLOwrW7x6.png" alt="image-20201112231743732" style="zoom:50%;" />

#### 快速重传／快速恢复

##### 快速重传算法的内容

- **接收方**每收到一个失序的报文段后就**立即**发出**重复确认**。
- 发送方只要**一连收到三个重复确认**就应当**立即重传**对方尚未收到的报文段。

##### eg

![image-20201112232145686](https://i.loli.net/2020/11/12/HfgN7mdeFxPhu4R.png)

##### 快速重传的内容

- 收到3个**重复确认**的时候，拥塞窗口 cwnd 现在不设置为 1，而是设置为慢开始门限 ssthresh 减半后的数值，直接开始加法增大

<img src="https://i.loli.net/2020/11/12/914WeYCxwyKn3tF.png" alt="image-20201112232359816" style="zoom:50%;" />

##### 发送窗口的上限值是什么？

- min(rwnd,cwnd)





### 面向连接传输

#### 3个步骤

- 建立连接
- 数据传输
- 断开连接

#### 建立连接【3次握手】

##### 为什么不使用2次握手呢？

- 由千网络不可靠，可能出现数据的丢失和重复。像上面的两次交换信息建立连接往往会出现严重的错误。

##### 3次握手的3个动作

- 请求连接方发送**连接请求包**到预期的接收方。
- 接收方回送一个**确认包**给请求方。
- 请求方回送—个包给接收方，对确认包进行认可。

##### eg

<img src="https://i.loli.net/2020/11/08/yve1Pduc7aqOTxw.png" alt="image-20201108105141762" style="zoom:50%;" />





#### 连接终止【3次握手】

##### 为什么不直接断开连接？

- 会造成数据丢失

![image-20201108105433629](https://i.loli.net/2020/11/08/zZu3iWMNeqUJbg9.png)

A 发送的第一个包正确到达B, A 发送第二个数据包后没有数据再发送了，千是A发出断连请求。而B 在收到第一个包后也发出了断连请求。结果A发送的第二个包未达到B 而丢失。

##### 为什么要3次握手？

- 防止数据包丢失

##### 3次握手的3个动作

- 请求方发送**终止连接请求包**。
- 响应方发送**终止连接确认包**。
- 请求方发送**认可确认包**。

![image-20201108110511758](https://i.loli.net/2020/11/08/xkJUQdmyRAVh23O.png)

##### eg

![image-20201108110554928](https://i.loli.net/2020/11/08/sZeAMKGgY3dSc2o.png)

![image-20201108110613779](https://i.loli.net/2020/11/08/nq4bxPweEVuChOA.png)

##### 什么是半开通连接？

- 一方已经删除连接，但是另外一方还在连接

## 用户数据报协议UDP

- UDP不提供可靠性，不提供端到端的**确认**和**重传**

### UDP的特点

- 端到端
- **无连接**
- 面向报文
- 尽力而为
- 任意交互
- 操作系统无关

### UDP报头格式

![image-20201108111805357](https://i.loli.net/2020/11/08/cCZnqIF2POyjWiG.png)

#### 源端口号

- 可选字段

#### 目的端口

#### UDP长度

- UDP报头和UDP数据长度之和

#### UDP校验和

- 可选字段， UDP 检验和覆盖**伪首部**【是IP报头的某一些域】、 UDP 首部和 UDP 数据。

#### 为什么UDP校验和要覆盖伪首部？

- 为了让UDP检测数据已经正确到达目的地



## 传输控制协议TCP

- TCP 提供一种**面向连接**的、**可靠**的**字节流**服务 。

### TCP的特点

- 面向连接
- 点对点
- **完全可靠性**
- 全双工通信
- 字节流接口
- 可靠的连接建立
- 友好的连接关闭

### TCP的报头格式

- TCP是一个没有**选择确认**和**否定**的滑动窗口协议

<img src="https://i.loli.net/2020/11/08/6rPujBtlvQ5D7yi.png" alt="image-20201108122747831" style="zoom:50%;" />

#### 什么是套接字socket?

- 一个IP地址和一个端口号

#### 为什么不需要选择确认？

- 因为确认**序号标识**接收方已经成功接收到的字节【捎带确认】

#### 当接收方接收到一个错误的报文段时候，接收方会怎么做？

- 发回一个对应**确认序号**的确认帧，也正因为如此，不需要否定帧

#### 当发送的报文丢失的时候，发送方会怎么做？

- 只要**计时器设置的重传时间到但还没有收到确认**，就要重传这一报文段

#### TCP采用了哪些技术？

- 对于**重复和乱序**的**重排技术**
- 对于**丢失**的重传技术
- 防止数据过载的**流量控制技术**

#### 标志位的含义

- 具体见书本232

![image-20201108123550123](https://i.loli.net/2020/11/08/JrEOQ7snbjvfkqF.png)



### TCP的连接的建立和释放

#### TCP的连接【 3次握手】

![image-20201109093800924](https://i.loli.net/2020/11/09/6FHNyd7W2O5q1GU.png)

- 请求端发送一个**SYN**表明端口，以及初始序号**ISN**
- 服务器端发送一个包含**服务器**的SYN作为响应，自身设置**ISN**，同时确认序号是**请求端的ISN+1**
- 客户端将发送一个确认序号**ISN+1**进行确认



#### TCP的释放【4次握手】

![image-20201109094138646](https://i.loli.net/2020/11/09/E4zjNfOtxVaKgs5.png)

- 当发送**FIN**的时候客户端的应用程序已经关闭，**FIN**确认帧只是应用程序自动发的

<img src="https://i.loli.net/2020/11/09/za7eUmHihqI1xCv.png" alt="image-20201109094242522" style="zoom:50%;" />



# 应用层

## 客户/服务器模型

## DNS【域名服务】

### 什么是DNS？

- 把**主机名字**到**IP地址**或者从**IP地址**到**主机名字**的映射

### 什么是反向查询？

- 从IP地址映射到主机名称

### 什么是域名系统？

- 域名系统是一个分布式数据库

### DNS的工作原理

#### 域名空间

#### 命名规则

- 叶节点的域代表主机

##### 如何保证域名可唯一标识域名树中的每一个结点

- DNS 要求兄弟结点（即具有同一个父结点的子结点）的命名具有唯一性



#### 代理技术

##### 如何实现管理分散化？

- 通过代理来实现
  - 数据存储分散化
  - 管理权分散化

##### eg

###### 未使用代理技术

<img src="https://i.loli.net/2020/11/13/yn1oAU3jhEYeFkf.png" alt="image-20201113151435172" style="zoom:80%;" />



<img src="https://i.loli.net/2020/11/13/3YdWUquzXAj6pwa.png" alt="image-20201113151446565" style="zoom: 50%;" />

<img src="https://i.loli.net/2020/11/13/OL3AgerkaISGibv.png" alt="image-20201113151455302" style="zoom:67%;" />

###### 使用代理技术

![image-20201113151534129](https://i.loli.net/2020/11/13/dXt7Hy3Cp9IKjwz.png)

![image-20201113151545648](https://i.loli.net/2020/11/13/P4R8DJdNKmgnaEI.png)

![image-20201113151603955](https://i.loli.net/2020/11/13/JRbYcgjVHyD6QTB.png)

#### 名称服务器

##### 什么是名称服务器？

- 是一个在后台运行的守护程序，随时**监听**来自**客户机**的请求。

#### 解释过程

1. 查询本地缓冲区【查看以前是否解析过主机名】
2. 解析器向本地域名服务器发出请求
3. 若本地域名服务器中没有存储则**解释方法**由2种
   - **重复解释**
   - **递归解释**

##### 重复解释

- 在重复解释中，名称服务器仅简单地将它所知道的最好答案返回给查询者既可，没有额外的查询

##### 递归查询

- 在递归查询中，被查询的名称服务器可以发送一个递归查询给其他的名称服务器，从而迫使它们找到答案并将答案返回，**也就是说，途径的名称服务器也更新了映射关系**

### DNS和ARP的比较

- DNS 是**应用层地址**与**网络层地址**之间映射关系的翻译
- ARP 是**网络层地址**与**数据链路层地址**之间映射关系的翻译

## 电子邮件

- 一种存贮转发的服务

### 电子邮件系统的组成

- 用户代理
- 邮件服务器
- 电子邮件协议：**SMTP POP3**

### SMTP【简单邮件传输协议】

- 发送端所使用

### POP 【邮件读取协议】

- 接收端所使用
- 脱机程序

### IMAP【接收邮件协议】

- 联机协议

### 工作过程

![image-20201113154537970](https://i.loli.net/2020/11/13/QgBRu6lFfb2xXke.png)



## 文件传输服务FTP

- 基于TCP
- 2种类型：匿名和非匿名

### FTP工作原理

- 客户端和服务器建立FTP连接的2个端口
  - 21端口 ：控制连接
  - 20端口：数据连接【在PORT模式】

### FTP的工作方式

#### 主动模式【PORT】

#### 被动模式【PASV】

### TFTP简单文本传输协议

- 使用UDP的69端口
- 只支持文件传输不支持交互



## 万维网【World Wide Web】

### 什么是万维网

- 是一个分布式超文本系统。

### 什么是WEB服务器

- 是指服务器及运行在服务器上运行的软件。

### 什么是HTML

- 超文本标记语言

### 什么是URL

- 统一资源定位器，Universal Resource Locator
- 编制方式：`传输协议：//主机地址 /路径和文件名`

### 什么是HTTP

- 超文本传输协议
- 在TCP协议的80端口
- 客户是浏览器，服务是 WWW 服务器 。
- HTTP 协议是 无状态 协议：不保留客户的状态
- HTTP 协议有 持续连接 和 非持续连接 。

#### 4种主要的请求类型

- GET 请求一个文档
- HEAD 请求状态信息
- POST 发送数据给服务器
- PUT 发送数据给服务器

#### 浏览器结构

![image-20201113160450953](https://i.loli.net/2020/11/13/SuULcM6bkxZgnpz.png)







# 数据通信基础

## 数据通信系统的组成

- 信源
- 发送设备
- 传输系统
- 接受设备
- 信宿

## 解决的问题

- 提高传输系统的利用率
- 接口、编码、同步
- 交换管理
- 差错控制
- 流量控制
- 寻址和路由
- 恢复
- 报文格式
- 网络管理







## 奈氏准则

- 有限带宽无噪声信道的**最大码元速率**和**信道带宽**的关系

$$
B = 2 * W (Baud)
$$

- 其中B是码元速率【即波特率】【 Baud per second】，单位是`Baud`；W是信道**带宽 **【Band Width】，单位是 `hz`
- 从公式中可以看出，奈氏准则只给出了码元传输速率的上限，并未给出信息传输速率的上限【也就是说，一个码元所对应的二进制位数没有做出规定】
- **码元速率【即波特率】和数据速率【即比特率】**关系【这里属于奈氏准则的推导部分】

$$
R = 2*W*log_2N=B*log_2N
$$

- 其中R表示数据速率【Data **Rate**】，单位是`bps bits per second`；`N`表示一个脉冲信号状态个数

- 也就是说，在有限带宽**无噪声**信道中，若已知脉冲信号个数

  **最大码元速率[Baud]，信道带宽[hz]，数据速率[bps]，**均可以知一求二

### 波特率和比特率的关系是什么

- 在数值上，波特率=比特率/码元所含比特数



## 香农定理

- 用于受干扰的信道，而香农定理描述了有限带宽；随机热噪声信道的**信道容量【最大数据传输率】**

$$
R_{max} = W*log_2(1+\frac{S}{N}) \ \ \ bps\\
其中,若信噪比使用分贝[ 不妨设为 x \ db]来表示，则x在数值上等于 10log_{10}(\frac{S}{N}) db\\
解方程可以得到参数\frac{S}{N}
$$

- 其中
  - $R_{max}$为最大数据传输率
  - W为信道带宽
  - $\frac{S}{N}$为信噪比

这样 信道容量和信道带宽的关系则出现了

- **带宽**是信道的**性质**，而信道容量会根据该性质和信噪比而发生改变

## 编码与调制

### 信号和数据之间的关系？

- **信号是数据的具体表现形式**
- 数字数据可**编码**为数字信号
- 模拟数据可通过**PCM编码器编码**为数字信号
- 数字数据可**调制**为模拟信号
- 模拟数据**可通过放大器调制器**调制为模拟信号



### 什么是编码？

- 把数据变换成数字信号称为编码

### 什么是调制？

- 把数据变换称模拟信号称为调制





### 数字数据编码为数字信号

#### 单极性编码

- 存在直流分量的问题
- 同步的问题

#### 极化编码

##### 非归零编码`NRZ`

###### 非归零电平编码`NRZ-L `没有同步机制

###### 非归零反相编码 NRZ-I【USB2.0】

`NRZ-I Non return to zero, inverted`  信号的**翻转提供了同步机制**

- eg 4B/5B编码  将4比特数据转换为不包含超过**连续**2个0的5比特数据，故有每一种4比特模式有对应的5比特模式 在这种对应的模式中，任何一个5比特模式都不会有连续的3个或以上的0

##### 归零编码`RZ`  【0跳变用于同步】

- 双相位码 各比特中的跳变用于同步，**跳变传递数据**

  - **曼彻斯特编码 【重点】**`MPR` 负->正代表1【IEEE802.3以太网所使用的编码方式】，频率比NRZ大一倍，所需要的带宽也大一倍。

  - **差分曼彻斯特编码【重点】 **`DME` ：可以实现自同步，抗干扰能力好，0和1的的跳变和前一个跳变有个，若是0，则和前一个跳变相同，若是1则和前一个跳变相反

- 双极性编码
  - 信号交替反转码 `AMI`
  - 8零替换编码`B8ZS`
  - 高密度双极性3零编码`HDB3`



### 数字数据调制为模拟信号

- 幅移键控 (ASK Amplitude Shift Key)
- 频移键控 (FSK Frequency Shift Key)
- 相移键控 (PSK Phase Shift Key)
- 正交调幅 (QAM Quadrature Amplitude Modulation)

### 模拟数据编码为数字信号

#### PCM的3个步骤

- 采样
- 量化
- 编码

### 模拟数据调制为模拟信号

- 略

### eg

- 测得一个**以太网**的波特率是40MBaud，那么其数据传输率是多少？
- ans=20Mb/s
- 以太网使用**曼彻斯特编码**，一个码元使用2个比特位来表示





## 线路配置

- 点到点连接
- 多点连接

## 传输模式

- 单工、半双工 和 全双工通信
- 串行传输 和 并行传输
  - 其中串行又分为 同步传输和异步传输
    - 其中同步传输等级又有：位同步和帧同步

### 什么是基带传输【局域网】

- 把基带信号直接送道数字信道中传输的方式称为**基带传输**

### 什么是频带传输

- 把基带信号经过调制送到模拟信道中传输的方式称为**频带传输**



## 数据交换技术

### 数据交换技术是什么？

- 指使得**没有物理链路**直接连接的两个或多个设备之间能够通信的技术。

### 数据交换技术的分类

- 电路
- 报文
- 分组

#### 电路交换【独占的物理线路】

- 电路交换机有：空分交换机和时分交换机
- eg 有线电话
- **3个步骤 电路建立，数据传输，电路拆除**

#### 报文交换【现在很少使用】

- 在网络中的每一个中间结点都检查一次报文的正缺陷和完整性才转发，因此其延时很大

#### 分组交换【即包交换，延时比报文交换延时小】

##### 数据报

- 将报文分组为各个包，每个包中都有控制信息，因此数据报可能不是有序地到底目的地，最终对数据报重新排序的任务交给传输层。
- 一条链路可以同时服务多个设备

##### 虚电路

- 属于同一次通信的所有包可以有序：在数据传输前就开始建立一条路径，按照这条路径传输
- 与电路交换的区别：虚电路可以在交换机中使用复用。
- 又有 交换虚电路和永久虚电路

###### 虚电路的3个阶段

- 虚电路的建立
- 数据传输
- 虚电路的释放

##### 虚电路的分组首部由目的地址吗？

- 没有，虚电路的分组首部包含**虚电路标识符**

![image-20201120101841858](https://i.loli.net/2020/11/20/SyUqlwoJBscAfCI.png)





## 错误检测

### 错误分类

- 单比特错误
- 多比特错误
- 突发错误



### 检错码，只能检查错误

#### 奇偶校验码

- 垂直（纵向）奇偶校验
- 水平（横向）奇偶校验
- 水平垂直奇偶校验。 

#### 循环冗余校验码【小心模2除法运算】

#### 检查和

### 纠错码，能纠正错误

- 海明码

- 编码效率





# 其他

## 局域网和广域网

- 作用范围区别
- 广域网是点对点【基于交换技术】，局域网是广播技术
- 局域网和广域网的互联是通过**路由器**实现
- 局域网没有网络层

## 分组交换的缺点

- 附加信息开销大

## 最早出现的计算机网络

- ARPAnet
- 



- 层间通信

  同一个网络结点上**相邻**层次**实体**之间的通信

- 对等层间通信

  不同网络结点上对等层实体间的通信

- 实通信

  层间通信+物理层间通信

- 虚通信

  除物理层间通信之外的层间通信



## 什么是信道？

- 信号在通信系统中传输的通道

## 信道和电路的关系？

- 一个电路一般由2个信道，**发送信道和接收信道**



- `SDU` Service Data Unit 
- `PDU` Protocol Data Unit 
- `PCI` Protocol Control Information



- 在OSI模型中，通信子网由**物理层，数据链路层，网络层**组成

## 对比MAC地址和IP地址

- 对应数据链路层和网络层
- 数据链路层地址信息只包括现在和下一个结点的物理地址， 当一个数据帧从一个结点传输到另一个结点时，地址信息也随之改变。而网络层地址则是信源地址和信宿地址，在**传输**中不会改变。这里指的是传输，而不是说在站点的改变。



- 广播地址和多播地址仅应用于UDP协议



## 流量控制

- 传输层有端到端的流量控制
- 网络层有主机到主机间的流量控制



## 网络互连设备

- 即 中继设备

- 中继器
  - 物理层
  - 在物理层实现透明二进制比特的复制，**补偿**信号的衰减
- 网桥
  - 物理层 
  - 数据链路层 数据帧的存储和转发 局域网的互连和寻址
- 路由器
  - 物理层 数据链路层 网络层
  - 对某次传输选择最好的一条路径
  - 只能在系统网络层协议的网络中 接受，转发和中继包
- 网关
  - 7层都有
  - 网关是一个**协议转换器**
  - 原理：接受一种协议格式，在转发前转换为另外一种协议格式

## TCP/IP协议







## 性能

- 信道吞吐量，比特率 单位时间成功发送的**信息量**  （即速率）

  - `bps` 位每秒

- 信道利用率 
  $$
  \frac{有效数据}{信道吞吐量}
  $$

- 延迟时间

  ```CQL
  信息包从源节点产生时刻 直到最后发送到 目的结点所经历的时间
  ```

- 信道带宽 ：最高速率，最大比特率。

- 传播速率： `m/s` 双绞线 的传播速率为`200m/us`

- **介质**的信道容量：一种**介质**可以传输的最大比特率

- 电路交换延迟

- ```
  电路交换延时 = 电路连接【建立】延时+ 发送延时 + 传播延时
  ```

- 分组交换延迟

- ```
  分组交换延迟 = 发送延时【这里有很多讲究：比如可并行】+ 传播延时
  ```













## 问答题

- 以太网为什么要限制最小帧长？
  - 以太网帧长度最大限制（MTU）是1518字节，最小长度是64字节
  - 限制帧的最大长度是为了避免一台设备长时间占用信道
  - 限制帧的最大长度是为了保证发送方在发送数据帧的时候能够检测冲突



- 为什么限制ICMP只和初始源站点通信？
  - 该问题的意思是为什么ICMP的差错报文的差错报文不再发送
  - 若不引入这样的机制会导致网络中可能会产生大量无穷无尽的差错报文【类似于广播风暴】

- 为什么ICMP报文用IP封装和发送？
  - 假如ICMP报文直接使用以太网协议的话，会导致其无法跨网关传说，所以需要IP协议封装才能跨网关传输



- 计算延时

![image-20201118134216389](https://i.loli.net/2020/11/18/yRAr4zj6KLPJvYg.png)

- ```
  总延时=发送延时+传播延时+处理延时+排队延时
  其中
  发送延时 = 分组长度/信道宽度
  传播延时 = 信道长度/传播速率
  ```

1. ```
   分组长度 = 1KB
   总延时 = 1000*1KB/(1.5Mb/s) + RTT/2 +握手时间【这里是额外的】
   ```

2. ```
   总延时 = 1000* 1KB/(1.5Mb/s) + RTT/2 + 握手时间 + 999 RTT
   ```

3. ```
   总延时 = 0【因为这里变成了0】 + RTT/2 + 握手时间 +49RTT
   ```



